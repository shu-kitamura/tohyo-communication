# 設計仕様書

## 1. 概要

プレゼンテーションやイベントで使用するリアルタイム投票Webアプリケーション。
開催者が質問と選択肢を作成し、参加者はQRコードからアクセスして投票。
投票結果は開催者の画面にリアルタイムでグラフ表示される。

**主な特徴：**
- 認証不要で手軽に利用可能
- QRコードによる簡単アクセス
- リアルタイムな結果表示（SSEを使用、Durable Objects から配信）
- 一人一票の投票制限
- 単一選択/複数選択の両対応
- Cloudflare Durable Objects にセッション単位で永続化
- 結果のエクスポート機能（CSV/JSON）
- 複数の投票セッションを同時開催可能
- 投票者も結果閲覧が可能（投票完了後または終了後）

## 2. 目的・背景

**背景：**
プレゼンテーションやワークショップなどの現地開催イベントにおいて、参加者の意見をリアルタイムで収集・可視化するニーズがある。既存の投票ツール（多数決さん等）は存在するものの、リアルタイム表示が分かりにくく、イベント会場での視認性に課題がある。

**目的：**
- 現地開催イベントで見やすいリアルタイム投票システムを実現
- 参加者が手軽に投票でき、結果が即座に視覚的に反映されるUXを提供
- 実装を通じてリアルタイムWeb技術の習得

**解決する課題：**
- 既存ツールのリアルタイム表示の分かりにくさ
- イベント会場での投票結果の視認性向上
- シンプルで使いやすい投票体験の提供

## 3. ユースケース

### 3.1 アクター
- **開催者**：投票セッションを作成・管理し、結果を確認する
- **参加者**：QRコードから投票画面にアクセスして投票する。投票後は結果を閲覧できる。
- **サーバ**：投票データの管理とリアルタイム通信を担う

### 3.2 基本フロー

#### 3.2.1 投票セッション作成フロー
1. 開催者：投票の質問文と選択肢（A, B, C, D等）を入力
2. 開催者：投票形式（単一選択/複数選択）を選択
3. 開催者 → サーバ：投票セッション作成リクエスト
4. サーバ：セッションIDを生成し、対応する Durable Object にセッションデータを永続化
5. サーバ → 開催者：セッションID、投票用URL、QRコード情報を返却
6. 開催者：QRコードと結果表示グラフを画面に表示

#### 3.2.2 投票フロー
1. 参加者：開催者の画面に表示されたQRコードを読み取り
2. 参加者：投票画面にアクセス（投票用URL）
3. 参加者：選択肢から投票
4. 参加者 → サーバ：投票リクエスト
5. サーバ：Durable Object で一人一票チェック（Cookie の voter_token とストレージを突き合わせ）
6. サーバ：Durable Object に投票データを記録し集計
7. サーバ → 開催者：Durable Object からリアルタイムで投票結果をSSE配信
8. 開催者：グラフがリアルタイムで更新される

#### 3.2.3 結果表示・エクスポートフロー
1. 開催者：グラフ表示形式を切り替え（棒グラフ ⇔ 円グラフ）
2. 開催者：エクスポート形式を選択（CSV/JSON）
3. 開催者 → サーバ：エクスポート要求
4. サーバ → 開催者：指定形式のデータを返却
5. 開催者：データをダウンロード

#### 3.2.4 投票者による結果閲覧フロー
1. 参加者：投票完了画面または終了画面で「結果を見る」ボタンをクリック
2. 参加者：結果表示画面（グラフ）に遷移
3. サーバ → 参加者：Durable Object からリアルタイムで投票結果をSSE配信（結果表示中のみ接続）
4. 参加者：グラフがリアルタイムで更新される

#### 3.2.5 投票終了フロー
1. 開催者 → サーバ：投票終了リクエスト
2. サーバ：該当セッションの Durable Object で投票受付終了状態に変更
3. 参加者が投票画面にアクセス → 「投票は終了しました」を表示
4. セッション作成から24時間または終了後に Durable Object ストレージから自動削除

### 3.3 例外フロー
- 参加者が既に投票済みの場合 → 「既に投票済みです」を表示（結果閲覧へ誘導）
- 投票が終了している場合 → 「投票は終了しました」を表示（結果閲覧へ誘導）
- 存在しないセッションIDでアクセス → 404エラー表示

## 4. 機能要件

### 4.1 開催者向け機能

#### 4.1.1 投票セッション管理
- **投票作成機能**
  - 質問文の入力（テキスト）
  - 選択肢の追加・削除・編集（自由テキスト、想定は10択程度）
  - 投票形式の選択（単一選択/複数選択）
  - セッションの作成と一意なIDの生成
  
- **投票開始機能**
  - 投票用URLの生成
  - QRコードの生成・表示
  - 投票受付開始

- **投票終了機能**
  - 投票受付の停止
  - セッションの終了

#### 4.1.2 結果表示機能
- **リアルタイム結果表示**
  - 投票結果のリアルタイム更新
  - 各選択肢の得票数表示
  - 各選択肢の得票率表示
  
- **グラフ表示機能**
  - 棒グラフ表示
  - 円グラフ表示
  - グラフ形式の切り替え

#### 4.1.3 エクスポート機能
- **CSV出力**
  - 選択肢と得票数のCSV形式出力
  
- **JSON出力**
  - 投票データのJSON形式出力

### 4.2 参加者向け機能

#### 4.2.1 投票機能
- **QRコードアクセス**
  - QRコード読み取りによる投票画面アクセス
  
- **投票実行**
  - 選択肢の表示
  - 単一選択投票（ラジオボタン形式）
  - 複数選択投票（チェックボックス形式）
  - 投票送信
  
- **投票結果フィードバック**
  - 投票完了メッセージの表示
  - 既に投票済みの場合のメッセージ表示
  - 投票終了の場合のメッセージ表示

#### 4.2.2 結果閲覧機能
- **結果グラフ表示**
  - 投票完了後または終了後にグラフを閲覧可能
  - リアルタイム更新（閲覧中のみSSE接続）

### 4.3 システム機能

#### 4.3.1 投票制御
- **一人一票制御**
  - Cookie方式による重複投票防止（`voter_token` を HttpOnly Cookie に保存）
  - 投票時にランダムなトークン（voter_token）を生成しCookieに保存
  - サーバ側は Durable Object 内で voter_token の存在をシリアライズ判定（再アクセス時にストレージ照合）
  
#### 4.3.2 リアルタイム通信
- **投票データの即時反映**
  - SSE (Server-Sent Events) によるリアルタイム通信
  - 投票があった際の開催者画面への即時通知
  - 投票者が結果閲覧中の即時通知
  
#### 4.3.3 データ管理
- **セッションデータ管理**
  - Cloudflare Durable Objects の per-session ストレージで永続化
  - セッション終了時、または作成から24時間で削除（DO アラーム/TTL などでクリーンアップ）
  - ワーカーの再起動や別インスタンスでも一貫した状態を再構築可能
  
#### 4.3.4 同時セッション対応
- **複数セッション管理**
  - 複数の投票セッションの同時開催
  - セッションIDを Durable Object のキーとしてシャーディングし、各セッションが独立したインスタンスで直列処理される

## 5. データモデル

### 5.1 Session（投票セッション）

投票セッション全体を表すデータモデル。

```typescript
{
  sessionId: string;          // 一意なセッションID（UUID等）
  question: string;           // 質問文
  voteType: 'single' | 'multiple';  // 単一選択 or 複数選択
  choices: Choice[];          // 選択肢の配列
  status: 'active' | 'closed'; // 投票中 or 終了
  createdAt: Date;            // 作成日時
  closedAt?: Date;            // 終了日時（オプション）
}
```

**例：**
```json
{
  "sessionId": "abc123-def456-ghi789",
  "question": "今日の昼食は何がいいですか？",
  "voteType": "single",
  "choices": [
    { "choiceId": "1", "text": "ラーメン", "voteCount": 15 },
    { "choiceId": "2", "text": "カレー", "voteCount": 8 },
    { "choiceId": "3", "text": "寿司", "voteCount": 12 }
  ],
  "status": "active",
  "createdAt": "2025-11-09T10:00:00Z"
}
```

### 5.2 Choice（選択肢）

投票の選択肢を表すデータモデル。

```typescript
{
  choiceId: string;           // 選択肢ID（セッション内で一意）
  text: string;               // 選択肢のテキスト（自由入力、想定上限255文字）
  voteCount: number;          // 得票数
}
```

### 5.3 Vote（投票記録）

個々の投票を記録するデータモデル。

```typescript
{
  voterToken: string;         // 投票者のCookieトークン
  sessionId: string;          // どのセッションへの投票か
  choiceIds: string[];        // 選択した選択肢のID（複数選択対応のため配列）
  votedAt: Date;              // 投票日時
}
```

**例（単一選択の場合）：**
```json
{
  "voterToken": "voter_xyz789abc456",
  "sessionId": "abc123-def456-ghi789",
  "choiceIds": ["1"],
  "votedAt": "2025-11-09T10:05:30Z"
}
```

**例（複数選択の場合）：**
```json
{
  "voterToken": "voter_xyz789abc456",
  "sessionId": "abc123-def456-ghi789",
  "choiceIds": ["1", "3"],
  "votedAt": "2025-11-09T10:05:30Z"
}
```

### 5.4 データの保持場所

- **Cloudflare Durable Objects** の per-session ストレージに保持
- セッションIDごとに独立したオブジェクトで一貫性を担保
- セッション終了時、または作成から24時間でストレージから削除（クリーンアップ実装を予定）

## 6. API仕様

### 6.1 開催者向けAPI

#### 6.1.1 投票セッション作成
**エンドポイント：** `POST /api/vote`

**リクエスト：**
```json
{
  "question": "今日の昼食は何がいいですか？",
  "voteType": "single",
  "choices": [
    { "text": "ラーメン" },
    { "text": "カレー" },
    { "text": "寿司" }
  ]
}
```

**レスポンス：** `201 Created`
```json
{
  "sessionId": "abc123-def456-ghi789",
  "voteUrl": "https://example.com/vote/abc123-def456-ghi789",
  "createdAt": "2025-11-09T10:00:00Z"
}
```

**備考：**
- QRコードはクライアント側（JavaScript）で `voteUrl` から生成
- `choices` にはテキストのみ指定、IDはサーバ側で自動採番
- 内部的にはセッションIDをキーに Durable Object を生成し、ストレージへ永続化する

---

#### 6.1.2 投票終了
**エンドポイント：** `POST /api/vote/:sessionId/close`

**リクエスト：** なし

**レスポンス：** `200 OK`
```json
{
  "sessionId": "abc123-def456-ghi789",
  "status": "closed",
  "closedAt": "2025-11-09T11:00:00Z"
}
```

**備考：**
- 対象セッションの Durable Object でステータスを `closed` に更新し、以降の投票を拒否する

---

#### 6.1.3 結果エクスポート
**エンドポイント：** `GET /api/vote/:sessionId/export`

**クエリパラメータ：**
- `format`: `csv` | `json` (必須)

**例：**
- CSV: `GET /api/vote/:sessionId/export?format=csv`
- JSON: `GET /api/vote/:sessionId/export?format=json`

**レスポンス（CSV）：** `200 OK`
```csv
選択肢,得票数,得票率
ラーメン,15,42.9%
カレー,8,22.9%
寿司,12,34.3%
```

**レスポンス（JSON）：** `200 OK`
```json
{
  "sessionId": "abc123-def456-ghi789",
  "question": "今日の昼食は何がいいですか？",
  "voteType": "single",
  "totalVotes": 35,
  "choices": [
    { "text": "ラーメン", "voteCount": 15, "percentage": 42.9 },
    { "text": "カレー", "voteCount": 8, "percentage": 22.9 },
    { "text": "寿司", "voteCount": 12, "percentage": 34.3 }
  ],
  "exportedAt": "2025-11-09T11:30:00Z"
}
```

---

#### 6.1.4 リアルタイム結果配信（SSE）
**エンドポイント：** `GET /api/vote/:sessionId/stream`

**説明：**
- Server-Sent Events (SSE) による一方向リアルタイム通信
- 投票があるたびに開催者の画面に結果を配信
- 投票者が結果閲覧中も配信

**イベント例：**
```
event: update
data: {"choices": [...], "totalVotes": 36}

event: closed
data: {"message": "投票が終了しました"}
```

**備考：**
- WebSocketの代替としてSSEを使用（サーバ→クライアントの一方向通信のため）
- SSEの送信元は該当セッションの Durable Object（投票受付・終了と整合する単一ソース）

---

### 6.2 参加者向けAPI

#### 6.2.1 投票セッション情報取得
**エンドポイント：** `GET /api/vote/:sessionId`

**リクエスト：** なし（Cookieで投票済みチェック）

**レスポンス（投票可能な場合）：** `200 OK`
```json
{
  "sessionId": "abc123-def456-ghi789",
  "question": "今日の昼食は何がいいですか？",
  "voteType": "single",
  "choices": [
    { "choiceId": "1", "text": "ラーメン" },
    { "choiceId": "2", "text": "カレー" },
    { "choiceId": "3", "text": "寿司" }
  ],
  "status": "active",
  "canVote": true
}
```

**レスポンス（投票済みの場合）：** `200 OK`
```json
{
  "sessionId": "abc123-def456-ghi789",
  "question": "今日の昼食は何がいいですか？",
  "voteType": "single",
  "choices": [
    { "choiceId": "1", "text": "ラーメン" },
    { "choiceId": "2", "text": "カレー" },
    { "choiceId": "3", "text": "寿司" }
  ],
  "status": "active",
  "canVote": false,
  "message": "既に投票済みです"
}
```

**レスポンス（投票終了の場合）：** `200 OK`
```json
{
  "sessionId": "abc123-def456-ghi789",
  "question": "今日の昼食は何がいいですか？",
  "status": "closed",
  "canVote": false,
  "message": "投票は終了しました"
}
```

---

#### 6.2.2 投票実行
**エンドポイント：** `POST /api/vote/:sessionId`

**リクエスト（単一選択）：**
```json
{
  "choiceIds": ["1"]
}
```

**リクエスト（複数選択）：**
```json
{
  "choiceIds": ["1", "3"]
}
```

**レスポンス（成功）：** `201 Created`
```json
{
  "message": "投票が完了しました",
  "votedAt": "2025-11-09T10:15:30Z"
}
```

**Set-Cookie:**
```
voter_token=voter_xyz789abc456; Path=/; HttpOnly; SameSite=Strict; Max-Age=86400
```

**レスポンス（既に投票済み）：** `409 Conflict`
```json
{
  "error": "既に投票済みです"
}
```

**レスポンス（投票終了）：** `403 Forbidden`
```json
{
  "error": "投票は終了しました"
}
```

**レスポンス（存在しないセッション）：** `404 Not Found`
```json
{
  "error": "セッションが見つかりません"
}
```

**備考：**
- サーバ側でCookieの `voter_token` を確認し、重複投票を防止
- 投票時に `voter_token` が無い場合は新規生成してCookieに保存
- クライアント側のチェックをすり抜けても、サーバ側で必ず再チェック

---

### 6.3 エラーレスポンス

全APIで共通のエラーレスポンス形式：

**400 Bad Request:**
```json
{
  "error": "不正なリクエストです",
  "details": "voteTypeはsingleまたはmultipleを指定してください"
}
```

**500 Internal Server Error:**
```json
{
  "error": "サーバーエラーが発生しました"
}
```

## 7. 画面設計・UI

### 7.1 画面構成

本アプリケーションは、開催者と参加者の2つのユーザーロールに対応する画面を提供する。

#### 7.1.1 共通画面
1. **トップページ** (`/`)

#### 7.1.2 開催者向け画面
1. **投票作成画面** (`/vote`)
2. **結果表示画面** (`/vote/:sessionId?view=organizer`)

#### 7.1.3 参加者向け画面
1. **投票画面** (`/vote/:sessionId`)
2. **投票完了画面** (同一画面内で状態変化)
3. **結果閲覧画面** (同一画面内で状態変化)

---

### 7.2 画面遷移図

#### 7.2.1 開催者の画面遷移

```
┌─────────────────┐
│   トップページ    │  `/`
│                 │
└────────┬────────┘
         │ 「投票を作成する」ボタンをクリック
         ▼
┌─────────────────┐
│   投票作成画面    │  `/vote`
│                 │
└────────┬────────┘
         │ 質問・選択肢を入力
         │ 投票作成ボタンをクリック
         ▼
┌─────────────────┐
│  結果表示画面     │  `/vote/:sessionId?view=organizer`
│  (開催者ビュー)   │
└─────────────────┘
    - QRコード表示
    - リアルタイムグラフ表示
    - グラフ切り替え
    - エクスポート
    - 投票終了
```

**遷移フロー：**
1. 開催者は `/` にアクセスし、トップページで「投票を作成する」ボタンをクリック
2. `/vote` にアクセスし、投票作成画面で質問と選択肢を入力
3. 「投票作成」ボタンをクリック
4. サーバがセッションを作成し、`sessionId` を返却
5. `/vote/:sessionId?view=organizer` にリダイレクト（開催者ビュー）
6. QRコードとリアルタイムグラフが表示され、投票を受け付ける

---

#### 7.2.2 参加者の画面遷移

```
┌─────────────────┐
│  QRコード読み取り │
└────────┬────────┘
         │ スマホでQRコードをスキャン
         ▼
┌─────────────────┐
│    投票画面      │  `/vote/:sessionId`
│  (参加者ビュー)   │
└────────┬────────┘
         │ 選択肢を選んで投票ボタンをクリック
         ▼
┌─────────────────┐
│  投票完了画面     │  (同一画面内で状態変化)
└────────┬────────┘
         │ 「結果を見る」ボタンをクリック
         ▼
┌─────────────────┐
│  結果閲覧画面     │  (同一画面内で状態変化)
└─────────────────┘
    - リアルタイムグラフ表示
    - 「戻る」ボタンで完了画面へ
```

**遷移フロー：**
1. 参加者は開催者の画面に表示されたQRコードをスマホで読み取り
2. `/vote/:sessionId` にアクセス（参加者ビュー）
3. 投票画面で選択肢を選んで投票
4. 投票完了メッセージを表示（同一画面内で状態が変化）
5. 「結果を見る」ボタンでグラフを表示

---

### 7.3 画面詳細設計

#### 7.3.1 トップページ (`/`)

**目的：**
サービスの紹介と投票作成画面への導線を提供するランディングページ。

**レイアウト：**
- デスクトップ・モバイル対応
- ヒーローセクション + 特徴紹介セクション

**UIコンポーネント：**
- ロゴ・サービス名
- キャッチコピー（「リアルタイム投票で、場を盛り上げよう」）
- 「投票を作成する」CTAボタン → `/vote` へ遷移
- 特徴紹介（リアルタイム更新、QRコードで即参加、見やすいグラフ表示）
- 「ログイン不要・無料」バッジ

---

#### 7.3.2 投票作成画面 (`/vote`)

**目的：**
開催者が投票セッションを作成するための画面。

**レイアウト：**
- デスクトップ・タブレット対応（開催者はPC想定）
- シンプルなフォーム形式

**UIコンポーネント：**

```
┌─────────────────────────────────────┐
│          投票作成画面                │
├─────────────────────────────────────┤
│                                     │
│  質問を入力してください              │
│  ┌───────────────────────────────┐ │
│  │ 今日の昼食は何がいいですか？    │ │
│  └───────────────────────────────┘ │
│                                     │
│  投票形式                            │
│  ○ 単一選択   ○ 複数選択            │
│                                     │
│  選択肢                              │
│  ┌───────────────────────────────┐ │
│  │ ラーメン                   [×] │ │
│  └───────────────────────────────┘ │
│  ┌───────────────────────────────┐ │
│  │ カレー                     [×] │ │
│  └───────────────────────────────┘ │
│  ┌───────────────────────────────┐ │
│  │ 寿司                       [×] │ │
│  └───────────────────────────────┘ │
│                                     │
│  [+ 選択肢を追加]                   │
│                                     │
│            [投票を作成]              │
│                                     │
└─────────────────────────────────────┘
```

**要素の説明：**
- **質問入力欄**：テキストエリア、プレースホルダー「質問を入力してください」
- **投票形式選択**：ラジオボタン（単一選択 / 複数選択）
- **選択肢入力欄**：テキストフィールド（動的に追加・削除可能）
- **削除ボタン (`×`)**：各選択肢の右側に配置、クリックで削除
- **選択肢追加ボタン**：クリックで新しい選択肢フィールドを追加
- **投票作成ボタン**：クリックでセッション作成APIを呼び出し、結果表示画面に遷移

**バリデーション：**
- 質問が未入力の場合はエラー表示
- 選択肢が2つ未満の場合はエラー表示
- 選択肢の最大数は10個（制限を設ける場合）

**デザインガイドライン：**
- シンプルで分かりやすいUI
- 入力フィールドは大きめに（タッチ操作も考慮）
- ボタンは目立つ色（プライマリカラー）
- エラーメッセージは赤色で明確に表示

---

#### 7.3.3 結果表示画面（開催者ビュー） (`/vote/:sessionId?view=organizer`)

**目的：**
開催者が投票用QRコードを表示し、リアルタイムで投票結果を確認する画面。

**レイアウト：**
- デスクトップ・タブレット対応
- プロジェクター投影を想定し、グラフを大きめに表示
- QRコードは右上または左上に小さめに配置

**UIコンポーネント（レイアウト案）：**

```
┌───────────────────────────────────────────────┐
│  [棒グラフ] [円グラフ]  [CSV] [JSON]          │  ← コントロールエリア
│                              [投票を終了] ┌──┐│
│                                          │QR││
│                                          │  ││  ← QRコード
│  今日の昼食は何がいいですか？              │  ││
│                                          └──┘│
│  ┌─────────────────────────────────────┐     │
│  │                                     │     │
│  │         グラフ表示エリア              │     │
│  │        (棒グラフ / 円グラフ)          │     │
│  │                                     │     │
│  │                                     │     │
│  │                                     │     │
│  │                                     │     │
│  │                                     │     │
│  │                                     │     │
│  └─────────────────────────────────────┘     │
│                                              │
│  総投票数: 35票                               │
│                                              │
│  ラーメン: 15票 (42.9%)                      │
│  カレー: 8票 (22.9%)                         │
│  寿司: 12票 (34.3%)                          │
│                                              │
└───────────────────────────────────────────────┘
```

**要素の説明：**

1. **コントロールエリア（画面上部）**
   - **グラフ切り替えボタン**：「棒グラフ」「円グラフ」のトグルボタン
   - **エクスポートボタン**：「CSV」「JSON」のボタン群
   - **投票終了ボタン**：クリックで投票受付を終了（確認ダイアログ表示）

2. **QRコード表示エリア（右上）**
   - 投票用URLのQRコードを表示
   - サイズ：150px × 150px 程度（スマホで読み取りやすいサイズ）
   - QRコード下にテキストでURL表示（オプション）

3. **質問表示エリア**
   - 投票の質問文を大きめのフォントで表示

4. **グラフ表示エリア（メイン）**
   - 棒グラフまたは円グラフをリアルタイム更新
   - グラフライブラリ（Recharts）を使用
   - アニメーション付きで投票結果が変化

5. **投票結果サマリー（画面下部）**
   - 総投票数
   - 各選択肢の得票数と得票率をテキストで表示（補助情報）

**リアルタイム更新：**
- SSE接続により、投票があるたびにグラフが自動更新
- アニメーション付きで視覚的に分かりやすく

**デザインガイドライン：**
- グラフは画面の60-70%を占める大きさ
- QRコードは邪魔にならない位置に小さめに配置
- ボタンは分かりやすいアイコン付き
- プロジェクター投影を想定し、コントラスト高めの配色

---

#### 7.3.4 投票画面（参加者ビュー） (`/vote/:sessionId`)

**目的：**
参加者がスマホから投票を行う画面。

**レイアウト：**
- **モバイルファースト設計**（スマホ縦持ち想定）
- シンプルで直感的なUI
- タップしやすいボタンサイズ

**UIコンポーネント（単一選択の場合）：**

```
┌─────────────────────┐
│                     │
│  今日の昼食は        │
│  何がいいですか？    │
│                     │
│  ○ ラーメン         │
│                     │
│  ○ カレー           │
│                     │
│  ○ 寿司             │
│                     │
│                     │
│     [投票する]       │
│                     │
└─────────────────────┘
```

**UIコンポーネント（複数選択の場合）：**

```
┌─────────────────────┐
│                     │
│  好きな食べ物を      │
│  選んでください      │
│  (複数選択可)        │
│                     │
│  ☑ ラーメン         │
│                     │
│  □ カレー           │
│                     │
│  ☑ 寿司             │
│                     │
│                     │
│     [投票する]       │
│                     │
└─────────────────────┘
```

**要素の説明：**
- **質問表示**：画面上部に大きめのフォントで表示
- **投票形式の案内**：複数選択の場合は「(複数選択可)」と表示
- **選択肢**：
  - 単一選択：ラジオボタン（大きめのタップエリア）
  - 複数選択：チェックボックス（大きめのタップエリア）
  - 選択肢テキストも含めて全体がタップ可能
- **投票ボタン**：
  - 画面下部に固定
  - 大きめのボタン（高さ50px以上）
  - プライマリカラーで目立つデザイン
  - 未選択の場合はボタンを無効化（グレーアウト）

**投票後の表示（投票完了画面）：**

```
┌─────────────────────┐
│                     │
│         ✓           │
│                     │
│  投票ありがとう      │
│  ございました！      │
│                     │
│  あなたの投票:       │
│  ・ラーメン         │
│                     │
│     [結果を見る]     │
│                     │
└─────────────────────┘
```

**投票済みの場合：**

```
┌─────────────────────┐
│                     │
│         ⓘ           │
│                     │
│  既に投票済みです    │
│                     │
│  ご協力ありがとう    │
│  ございました       │
│                     │
│     [結果を見る]     │
│                     │
└─────────────────────┘
```

**投票終了の場合：**

```
┌─────────────────────┐
│                     │
│         ⓘ           │
│                     │
│  投票は終了しました  │
│                     │
│     [結果を見る]     │
│                     │
└─────────────────────┘
```

**デザインガイドライン：**
- スマホ縦持ちで片手操作できるUI
- タップターゲットは最低44px × 44px（Appleガイドライン）
- フォントサイズは16px以上（可読性確保）
- シンプルな配色、余白を広めに取る
- ローディング中はボタンにスピナー表示

---

### 7.4 レスポンシブデザイン

#### 7.4.1 開催者画面（投票作成・結果表示）
- **デスクトップ（1024px以上）**：横幅を活かしたレイアウト
- **タブレット（768px - 1023px）**：やや縮小、グラフサイズ調整
- **モバイル（767px以下）**：縦スクロール、QRコードを上部に移動

#### 7.4.2 参加者画面（投票画面）
- **モバイルファースト**で設計
- タブレット・デスクトップでも問題なく表示されるが、基本はスマホ想定

---

### 7.5 UIコンポーネント設計

#### 7.5.1 共通コンポーネント
- **Button**：プライマリ、セカンダリ、ダンジャー（削除・終了用）
- **Input / TextArea**：フォーム入力用
- **Radio / Checkbox**：投票形式・投票画面用
- **Modal / Dialog**：投票終了確認、エラー表示用
- **ResultChart**：グラフ表示（開催者・投票者共通）

#### 7.5.2 専用コンポーネント
- **OrganizerView**：開催者用画面（QRコード、管理メニュー付き）
- **VoterView**：投票者用画面（投票フォーム、完了メッセージ、結果閲覧）
- **QRCodeDisplay**：QRコード生成・表示
- **VoteOptionList**：投票画面の選択肢リスト
- **ChoiceInput**：投票作成画面の選択肢入力フィールド

---

### 7.6 ユーザー体験（UX）の考慮点

#### 7.6.1 開催者の体験
- **スムーズな投票作成**：最小限の入力で素早く投票を開始できる
- **リアルタイムフィードバック**：投票があるたびにグラフが即座に更新され、視覚的に楽しい
- **プロジェクター投影対応**：会場の参加者が遠くからでもグラフを見やすい
- **操作が簡単**：投票終了、エクスポートなど、主要な操作はワンクリック

#### 7.6.2 参加者の体験
- **手軽なアクセス**：QRコードを読み取るだけで投票画面に到達
- **シンプルな投票**：選択肢を選んでボタンを押すだけ（3ステップ以内）
- **明確なフィードバック**：投票完了、投票済み、投票終了などの状態が一目で分かる
- **結果の共有**：投票後に自分も結果を確認できることで、参加意識が高まる
- **モバイル最適化**：スマホで快適に操作できる

#### 7.6.3 エラーハンドリング
- **ネットワークエラー**：リトライボタン、エラーメッセージ表示
- **投票の重複**：Cookieで制御、重複投票を試みた場合は既に投票済みメッセージ
- **セッション不在**：404エラー画面、ホームに戻るリンク表示

---

### 7.7 アクセシビリティ

- **キーボード操作**：Tab移動、Enterで送信など
- **スクリーンリーダー対応**：適切なARIAラベル、セマンティックHTML
- **カラーコントラスト**：WCAG AA基準（4.5:1以上）
- **フォーカス表示**：フォーカスリングを明確に表示
- **ダークモード対応**：OS設定に応じた配色切り替え

---

### 7.8 カラーパレット（案）

実装時に調整予定だが、以下のようなカラーリングを想定：

- **プライマリカラー**：青系（#3B82F6）- ボタン、リンク
- **セカンダリカラー**：緑系（#10B981）- 成功メッセージ
- **ダンジャーカラー**：赤系（#EF4444）- 削除、終了、エラー
- **背景色**：白・グレー系（#FFFFFF, #F9FAFB）
- **テキスト**：ダークグレー（#1F2937）
- **グラフカラー**：多色パレット（選択肢ごとに異なる色）

---

### 7.9 アニメーション・インタラクション

- **グラフ更新**：投票があるたびにスムーズにアニメーション（0.3s ease-out）
- **ボタンホバー**：色の変化、わずかな拡大
- **投票完了**：チェックマークのフェードイン
- **ローディング**：スピナー表示（API通信中）

## 8. 非機能要件

### 8.1 性能要件

#### 8.1.1 レスポンスタイム
- **API応答時間**：1秒以下
- **投票実行**：投票ボタン押下から完了メッセージ表示まで1秒以内
- **画面初期表示**：ページロード完了まで2秒以内

#### 8.1.2 リアルタイム性
- **投票結果反映**：参加者が投票してから開催者画面のグラフに反映されるまで1秒程度
- **SSE接続の遅延**：投票データ送信から開催者への通知まで極力短く

#### 8.1.3 同時接続数
- **想定参加者数**：50人程度
- **同時投票処理**：50人が同時に投票しても正常に処理できること
- **同時セッション数**：複数セッションの同時開催に対応

---

### 8.2 セキュリティ要件

#### 8.2.1 重複投票防止
- **Cookie方式**による一人一票制御
  - 投票時にランダムなトークン（`voter_token`）を生成
  - HttpOnly、SameSite=Strict属性でCookieに保存
  - 有効期限：24時間
- サーバ側で必ず再チェック（クライアント側のチェックは補助）

#### 8.2.2 入力値検証
- **質問文**：255文字以内、XSS対策のためHTMLタグをエスケープ
- **選択肢**：各選択肢100文字以内、最大10個まで
- **投票データ**：選択肢IDの形式チェック、存在確認

#### 8.2.3 不正投票対策
- **Bot対策**：現時点では不要（現地開催イベント想定のため、大量アクセスを受けにくい）
- **レートリミット**：将来的に検討
- **CAPTCHA**：不要

#### 8.2.4 通信の保護
- **本番環境**：HTTPS通信必須
- **開発環境**：HTTP可（localhost）

#### 8.2.5 CORS設定
- **Next.jsの同一プロジェクト内**（App Router + API Routes）で実装するため、CORS設定は不要
- フロントエンドとバックエンドが同一オリジンで動作

#### 8.2.6 データ保護
- **Durable Object ストレージ**：セッション単位で保持（低機密データ想定）
- **環境変数管理**：APIキーや設定値は環境変数で管理（必要に応じて）
- **ログ出力**：個人情報（IPアドレス等）はログに記録しない

---

### 8.3 可用性・信頼性

**現時点では詳細な可用性要件は定めない。**

- イベント開催中の安定稼働を目指す
- Durable Object による永続化のため、サーバ再起動を跨いで状態を保持する前提

---

### 8.4 スケーラビリティ

**現時点では詳細なスケーラビリティ要件は定めない。**

- 想定規模（50人程度）であれば、単一サーバで十分
- 将来的に大規模イベントに対応する場合は再検討

---

### 8.5 保守性・運用性

#### 8.5.1 ログ管理
- **エラーログ**：記録する
  - サーバエラー（500系）
  - バリデーションエラー
  - API呼び出し失敗
  - SSE接続エラー
- **アクセスログ**：記録しない（個人情報保護のため）
- **ログ出力先**：標準出力（stdout/stderr）

#### 8.5.2 監視
- **現時点では不要**
- 将来的には Cloudflare Dashboard/Logs を活用可能

#### 8.5.3 デプロイ・ホスティング
- **優先**：Cloudflare Workers + Durable Objects（OpenNext を使用）
- **設定**：`wrangler.toml`/`wrangler.jsonc` で DO バインドとビルド設定を管理
- **CI/CD**：GitHub Actions から `opennextjs-cloudflare deploy` または `wrangler deploy` を実行

#### 8.5.4 セッションのライフサイクル管理
- **タイムアウト設定**：セッション作成から24時間経過後、自動削除（Durable Object のストレージクリーンアップ/アラームで実施）
- **手動終了**：開催者が「投票終了」ボタンを押した場合、Durable Object で即座に投票受付終了
- **再起動耐性**：ワーカーの再配置・再起動時も DO ストレージから復元

---

### 8.6 互換性・対応環境

#### 8.6.1 ブラウザ対応
- **必須対応**：
  - Google Chrome（最新版）
  - Safari（最新版）
  - Microsoft Edge（最新版）
- **推奨対応**：
  - Firefox（最新版）
- **非対応**：
  - Internet Explorer 11以下
  - 古いバージョンのブラウザ

#### 8.6.2 モバイルOS
- **iOS**：バージョン指定なし（最新版で動作確認）
- **Android**：バージョン指定なし（最新版で動作確認）
- **テスト端末**：iPhone 13 mini を基準に動作確認

#### 8.6.3 画面サイズ
- **最小対応サイズ**：iPhone 13 mini（375px × 812px）
- **推奨サイズ**：
  - モバイル：375px ～ 430px（縦持ち）
  - タブレット：768px ～ 1024px
  - デスクトップ：1024px ～ 1920px

#### 8.6.4 ネットワーク環境
- **想定環境**：イベント会場のWi-Fi、参加者のモバイル回線（4G/5G）
- **オフライン対応**：不要（常時オンライン前提）

---

### 8.7 ユーザビリティ要件

#### 8.7.1 操作の簡単さ
- **開催者**：投票作成から開始までを3ステップ以内で完了
- **参加者**：QRコード読み取りから投票完了まで3ステップ以内



## 9. 技術スタック

### 9.1 フロントエンド

#### 9.1.1 フレームワーク・ライブラリ
- **Next.js 15.5.6**：React フレームワーク（App Router使用）
- **React 19.2.0**：UIライブラリ
- **TypeScript 5.x**：型安全な開発

#### 9.1.2 スタイリング
- **Tailwind CSS 4.x**：ユーティリティファーストCSSフレームワーク
- **@tailwindcss/postcss 4.x**：PostCSS統合

#### 9.1.3 開発ツール
- **ESLint 9.x**：コード品質チェック
- **eslint-config-next**：Next.js推奨のESLint設定

---

### 9.2 バックエンド

#### 9.2.1 API
- **Next.js App Router - Route Handlers**：APIエンドポイント実装
- **Node.js**：実行環境
- **Cloudflare Durable Objects 呼び出し**：APIハンドラからセッションIDをキーに DO を呼び出し、状態管理を委譲

#### 9.2.2 データストア
- **Cloudflare Durable Objects**：セッションIDをキーにした per-session ストレージ
- 永続性と直列処理を DO が担保し、ワーカーの再起動を跨いでも保持

#### 9.2.3 リアルタイム通信
- **Server-Sent Events (SSE)**：標準Web APIを使用したサーバ→クライアントの一方向通信

---

### 9.3 今後追加予定のライブラリ

実装フェーズで以下のライブラリを追加予定：

- **QRコード生成**：qrcode.react
- **グラフ描画**：Recharts
- **UUID生成**：uuid
- **CSV生成**：papa-parse または自前実装
- **画像エクスポート**：html2canvas または canvas API

---

### 9.4 ホスティング・デプロイ

- **本番環境**：Cloudflare Workers（Durable Objects をバインド）
- **開発環境**：ローカル（localhost:3000）+ `opennextjs-cloudflare preview` / Wrangler プレビュー
- **CI/CD**：GitHub Actions（`opennextjs-cloudflare build/deploy` や `wrangler deploy` を実行）
