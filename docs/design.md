# 設計仕様書

## 1. 概要

プレゼンテーションやイベントで使用するリアルタイム投票Webアプリケーション。
開催者が質問と選択肢を作成し、参加者はQRコードからアクセスして投票。
投票結果は開催者の画面にリアルタイムでグラフ表示される。

**主な特徴：**
- 認証不要で手軽に利用可能
- QRコードによる簡単アクセス
- リアルタイムな結果表示（SSEまたはWebSocket）
- 一人一票の投票制限
- 単一選択/複数選択の両対応
- データは永続化せず、セッション終了で消去
- 結果のエクスポート機能（CSV/JSON/画像）
- 複数の投票セッションを同時開催可能

## 2. 目的・背景

**背景：**
プレゼンテーションやワークショップなどの現地開催イベントにおいて、参加者の意見をリアルタイムで収集・可視化するニーズがある。既存の投票ツール（多数決さん等）は存在するものの、リアルタイム表示が分かりにくく、イベント会場での視認性に課題がある。

**目的：**
- 現地開催イベントで見やすいリアルタイム投票システムを実現
- 参加者が手軽に投票でき、結果が即座に視覚的に反映されるUXを提供
- 実装を通じてリアルタイムWeb技術の習得

**解決する課題：**
- 既存ツールのリアルタイム表示の分かりにくさ
- イベント会場での投票結果の視認性向上
- シンプルで使いやすい投票体験の提供

## 3. ユースケース

### 3.1 アクター
- **開催者**：投票セッションを作成・管理し、結果を確認する
- **参加者**：QRコードから投票画面にアクセスして投票する
- **サーバ**：投票データの管理とリアルタイム通信を担う

### 3.2 基本フロー

#### 3.2.1 投票セッション作成フロー
1. 開催者：投票の質問文と選択肢（A, B, C, D等）を入力
2. 開催者：投票形式（単一選択/複数選択）を選択
3. 開催者 → サーバ：投票セッション作成リクエスト
4. サーバ：セッションIDを生成し、投票データをメモリに保存
5. サーバ → 開催者：セッションID、投票用URL、QRコード情報を返却
6. 開催者：QRコードと結果表示グラフを画面に表示

#### 3.2.2 投票フロー
1. 参加者：開催者の画面に表示されたQRコードを読み取り
2. 参加者：投票画面にアクセス（投票用URL）
3. 参加者：選択肢から投票
4. 参加者 → サーバ：投票リクエスト
5. サーバ：一人一票チェック（Cookie/SessionStorage等で重複確認）
6. サーバ：投票データを記録
7. サーバ → 開催者：リアルタイムで投票結果を更新通知（SSE/WebSocket）
8. 開催者：グラフがリアルタイムで更新される

#### 3.2.3 結果表示・エクスポートフロー
1. 開催者：グラフ表示形式を切り替え（棒グラフ ⇔ 円グラフ）
2. 開催者：エクスポート形式を選択（CSV/JSON/画像）
3. 開催者 → サーバ：エクスポート要求
4. サーバ → 開催者：指定形式のデータを返却
5. 開催者：データをダウンロード

#### 3.2.4 投票終了フロー
1. 開催者 → サーバ：投票終了リクエスト
2. サーバ：該当セッションを投票受付終了状態に変更
3. 参加者が投票画面にアクセス → 「投票は終了しました」を表示
4. 開催者：ブラウザを閉じる → サーバのメモリから削除（またはタイムアウトで自動削除）

### 3.3 例外フロー
- 参加者が既に投票済みの場合 → 「既に投票済みです」を表示
- 投票が終了している場合 → 「投票は終了しました」を表示
- 存在しないセッションIDでアクセス → 404エラー表示

## 4. 機能要件

### 4.1 開催者向け機能

#### 4.1.1 投票セッション管理
- **投票作成機能**
  - 質問文の入力（テキスト）
  - 選択肢の追加・削除・編集（自由テキスト、想定は10択程度）
  - 投票形式の選択（単一選択/複数選択）
  - セッションの作成と一意なIDの生成
  
- **投票開始機能**
  - 投票用URLの生成
  - QRコードの生成・表示
  - 投票受付開始

- **投票終了機能**
  - 投票受付の停止
  - セッションの終了

#### 4.1.2 結果表示機能
- **リアルタイム結果表示**
  - 投票結果のリアルタイム更新
  - 各選択肢の得票数表示
  - 各選択肢の得票率表示
  
- **グラフ表示機能**
  - 棒グラフ表示
  - 円グラフ表示
  - グラフ形式の切り替え

#### 4.1.3 エクスポート機能
- **CSV出力**
  - 選択肢と得票数のCSV形式出力
  
- **JSON出力**
  - 投票データのJSON形式出力
  
- **画像出力**
  - グラフの画像（PNG/JPEG）出力

### 4.2 参加者向け機能

#### 4.2.1 投票機能
- **QRコードアクセス**
  - QRコード読み取りによる投票画面アクセス
  
- **投票実行**
  - 選択肢の表示
  - 単一選択投票（ラジオボタン形式）
  - 複数選択投票（チェックボックス形式）
  - 投票送信
  
- **投票結果フィードバック**
  - 投票完了メッセージの表示
  - 既に投票済みの場合のメッセージ表示
  - 投票終了の場合のメッセージ表示

### 4.3 システム機能

#### 4.3.1 投票制御
- **一人一票制御**
  - Cookie方式による重複投票防止
  - 投票時にランダムなトークン（voter_token）を生成しCookieに保存
  - 再アクセス時にCookieの有無で投票済みを判定
  
#### 4.3.2 リアルタイム通信
- **投票データの即時反映**
  - SSEまたはWebSocketによるリアルタイム通信
  - 投票があった際の開催者画面への即時通知
  
#### 4.3.3 データ管理
- **セッションデータ管理**
  - メモリ内での投票データ保持
  - セッション終了時のデータ削除
  - タイムアウトによる自動削除（オプション）
  
#### 4.3.4 同時セッション対応
- **複数セッション管理**
  - 複数の投票セッションの同時開催
  - セッションIDによる識別と分離

## 5. データモデル

### 5.1 Session（投票セッション）

投票セッション全体を表すデータモデル。

```typescript
{
  sessionId: string;          // 一意なセッションID（UUID等）
  question: string;           // 質問文
  voteType: 'single' | 'multiple';  // 単一選択 or 複数選択
  choices: Choice[];          // 選択肢の配列
  status: 'active' | 'closed'; // 投票中 or 終了
  createdAt: Date;            // 作成日時
  closedAt?: Date;            // 終了日時（オプション）
}
```

**例：**
```json
{
  "sessionId": "abc123-def456-ghi789",
  "question": "今日の昼食は何がいいですか？",
  "voteType": "single",
  "choices": [
    { "choiceId": "1", "text": "ラーメン", "voteCount": 15 },
    { "choiceId": "2", "text": "カレー", "voteCount": 8 },
    { "choiceId": "3", "text": "寿司", "voteCount": 12 }
  ],
  "status": "active",
  "createdAt": "2025-11-09T10:00:00Z"
}
```

### 5.2 Choice（選択肢）

投票の選択肢を表すデータモデル。

```typescript
{
  choiceId: string;           // 選択肢ID（セッション内で一意）
  text: string;               // 選択肢のテキスト（自由入力、想定上限255文字）
  voteCount: number;          // 得票数
}
```

### 5.3 Vote（投票記録）

個々の投票を記録するデータモデル。

```typescript
{
  voterToken: string;         // 投票者のCookieトークン
  sessionId: string;          // どのセッションへの投票か
  choiceIds: string[];        // 選択した選択肢のID（複数選択対応のため配列）
  votedAt: Date;              // 投票日時
}
```

**例（単一選択の場合）：**
```json
{
  "voterToken": "voter_xyz789abc456",
  "sessionId": "abc123-def456-ghi789",
  "choiceIds": ["1"],
  "votedAt": "2025-11-09T10:05:30Z"
}
```

**例（複数選択の場合）：**
```json
{
  "voterToken": "voter_xyz789abc456",
  "sessionId": "abc123-def456-ghi789",
  "choiceIds": ["1", "3"],
  "votedAt": "2025-11-09T10:05:30Z"
}
```

### 5.4 データの保持場所

- **サーバメモリ内**に全データを保持
- データベースは使用しない
- セッション終了時またはタイムアウトでメモリから削除

## 6. API仕様

### 6.1 開催者向けAPI

#### 6.1.1 投票セッション作成
**エンドポイント：** `POST /vote`

**リクエスト：**
```json
{
  "question": "今日の昼食は何がいいですか？",
  "voteType": "single",
  "choices": [
    { "text": "ラーメン" },
    { "text": "カレー" },
    { "text": "寿司" }
  ]
}
```

**レスポンス：** `201 Created`
```json
{
  "sessionId": "abc123-def456-ghi789",
  "voteUrl": "https://example.com/vote/abc123-def456-ghi789",
  "createdAt": "2025-11-09T10:00:00Z"
}
```

**備考：**
- QRコードはクライアント側（JavaScript）で `voteUrl` から生成
- `choices` にはテキストのみ指定、IDはサーバ側で自動採番

---

#### 6.1.2 投票終了
**エンドポイント：** `POST /vote/:sessionId/close`

**リクエスト：** なし

**レスポンス：** `200 OK`
```json
{
  "sessionId": "abc123-def456-ghi789",
  "status": "closed",
  "closedAt": "2025-11-09T11:00:00Z"
}
```

---

#### 6.1.3 結果エクスポート
**エンドポイント：** `GET /vote/:sessionId/export`

**クエリパラメータ：**
- `format`: `csv` | `json` | `image` (必須)
- `chart`: `bar` | `pie` (formatがimageの場合のみ必須)

**例：**
- CSV: `GET /vote/:sessionId/export?format=csv`
- JSON: `GET /vote/:sessionId/export?format=json`
- 棒グラフ画像: `GET /vote/:sessionId/export?format=image&chart=bar`
- 円グラフ画像: `GET /vote/:sessionId/export?format=image&chart=pie`

**レスポンス（CSV）：** `200 OK`
```csv
選択肢,得票数,得票率
ラーメン,15,42.9%
カレー,8,22.9%
寿司,12,34.3%
```

**レスポンス（JSON）：** `200 OK`
```json
{
  "sessionId": "abc123-def456-ghi789",
  "question": "今日の昼食は何がいいですか？",
  "voteType": "single",
  "totalVotes": 35,
  "choices": [
    { "text": "ラーメン", "voteCount": 15, "percentage": 42.9 },
    { "text": "カレー", "voteCount": 8, "percentage": 22.9 },
    { "text": "寿司", "voteCount": 12, "percentage": 34.3 }
  ],
  "exportedAt": "2025-11-09T11:30:00Z"
}
```

**レスポンス（画像）：** `200 OK`
- Content-Type: `image/png`
- グラフ画像のバイナリデータ

---

#### 6.1.4 リアルタイム結果配信（SSE）
**エンドポイント：** `GET /vote/:sessionId/stream`

**説明：**
- Server-Sent Events (SSE) による一方向リアルタイム通信
- 投票があるたびに開催者の画面に結果を配信

**イベント例：**
```
event: vote
data: {"choiceId": "1", "voteCount": 16, "totalVotes": 36}

event: vote
data: {"choiceId": "2", "voteCount": 9, "totalVotes": 37}

event: closed
data: {"message": "投票が終了しました"}
```

**備考：**
- WebSocketの代替としてSSEを使用（サーバ→クライアントの一方向通信のため）
- 必要に応じてWebSocketに変更可能

---

### 6.2 参加者向けAPI

#### 6.2.1 投票セッション情報取得
**エンドポイント：** `GET /vote/:sessionId`

**リクエスト：** なし（Cookieで投票済みチェック）

**レスポンス（投票可能な場合）：** `200 OK`
```json
{
  "sessionId": "abc123-def456-ghi789",
  "question": "今日の昼食は何がいいですか？",
  "voteType": "single",
  "choices": [
    { "choiceId": "1", "text": "ラーメン" },
    { "choiceId": "2", "text": "カレー" },
    { "choiceId": "3", "text": "寿司" }
  ],
  "status": "active",
  "canVote": true
}
```

**レスポンス（投票済みの場合）：** `200 OK`
```json
{
  "sessionId": "abc123-def456-ghi789",
  "question": "今日の昼食は何がいいですか？",
  "voteType": "single",
  "choices": [
    { "choiceId": "1", "text": "ラーメン" },
    { "choiceId": "2", "text": "カレー" },
    { "choiceId": "3", "text": "寿司" }
  ],
  "status": "active",
  "canVote": false,
  "message": "既に投票済みです"
}
```

**レスポンス（投票終了の場合）：** `200 OK`
```json
{
  "sessionId": "abc123-def456-ghi789",
  "question": "今日の昼食は何がいいですか？",
  "status": "closed",
  "canVote": false,
  "message": "投票は終了しました"
}
```

---

#### 6.2.2 投票実行
**エンドポイント：** `POST /vote/:sessionId`

**リクエスト（単一選択）：**
```json
{
  "choiceIds": ["1"]
}
```

**リクエスト（複数選択）：**
```json
{
  "choiceIds": ["1", "3"]
}
```

**レスポンス（成功）：** `201 Created`
```json
{
  "message": "投票が完了しました",
  "votedAt": "2025-11-09T10:15:30Z"
}
```

**Set-Cookie:**
```
voter_token=voter_xyz789abc456; Path=/; HttpOnly; SameSite=Strict; Max-Age=86400
```

**レスポンス（既に投票済み）：** `409 Conflict`
```json
{
  "error": "既に投票済みです"
}
```

**レスポンス（投票終了）：** `403 Forbidden`
```json
{
  "error": "投票は終了しました"
}
```

**レスポンス（存在しないセッション）：** `404 Not Found`
```json
{
  "error": "セッションが見つかりません"
}
```

**備考：**
- サーバ側でCookieの `voter_token` を確認し、重複投票を防止
- 投票時に `voter_token` が無い場合は新規生成してCookieに保存
- クライアント側のチェックをすり抜けても、サーバ側で必ず再チェック

---

### 6.3 エラーレスポンス

全APIで共通のエラーレスポンス形式：

**400 Bad Request:**
```json
{
  "error": "不正なリクエストです",
  "details": "voteTypeはsingleまたはmultipleを指定してください"
}
```

**500 Internal Server Error:**
```json
{
  "error": "サーバーエラーが発生しました"
}
```

## 7. 画面設計・UI

<ここに「画面遷移、UIコンポーネント、ユーザー体験」を書く>

## 8. 非機能要件

<ここに「性能、セキュリティ、可用性などの要件」を書く>

## 9. 技術スタック

<ここに「使用する技術、フレームワーク、ライブラリ」を書く>

## 10. 実装計画

<ここに「実装の優先順位、フェーズ分け」を書く>
